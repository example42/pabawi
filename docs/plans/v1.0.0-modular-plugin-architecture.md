# Pabawi v1.0.0 - Modular Plugin Architecture Plan

**Status:** Draft for Review  
**Created:** 2026-01-31  
**Target Version:** 1.0.0

## Executive Summary

This plan describes a complete architectural refactoring of Pabawi to support a modular, extensible plugin system with:

- **Full-stack plugins** providing backend capabilities, frontend widgets, and CLI commands
- **Capability-based interface** replacing type-based plugin categories
- **RBAC (Role-Based Access Control)** enforced across Web UI, REST API, and CLI
- **Declarative YAML configuration** with environment variable overrides
- **Dynamic UI composition** with permission-aware plugin widgets
- **Extensible CLI** with auto-generated commands from plugin schemas
- **Debug mode** with correlation tracking across all interfaces
- **Database abstraction layer** for future database engine support
- **Plugin marketplace readiness** for third-party integrations

## Architecture Overview

### Three-Interface Platform

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Pabawi Platform                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ Web UI   â”‚      â”‚ REST API â”‚      â”‚   CLI    â”‚      â”‚
â”‚  â”‚ (Svelte) â”‚      â”‚ (Express)â”‚      â”‚  (Node)  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚                 â”‚                  â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                         â”‚                               â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚ Plugin System       â”‚                    â”‚
â”‚              â”‚ - Capability Reg.   â”‚                    â”‚
â”‚              â”‚ - RBAC Engine       â”‚                    â”‚
â”‚              â”‚ - Widget Registry   â”‚                    â”‚
â”‚              â”‚ - Integration Mgr   â”‚                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                         â”‚                               â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚       â”‚                 â”‚                 â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Bolt   â”‚       â”‚PuppetDB â”‚       â”‚ Hiera  â”‚       â”‚
â”‚  â”‚ Plugin  â”‚       â”‚ Plugin  â”‚       â”‚ Plugin â”‚       â”‚
â”‚  â”‚         â”‚       â”‚         â”‚       â”‚        â”‚       â”‚
â”‚  â”‚Backend  â”‚       â”‚Backend  â”‚       â”‚Backend â”‚       â”‚
â”‚  â”‚Frontend â”‚       â”‚Frontend â”‚       â”‚Frontendâ”‚       â”‚
â”‚  â”‚CLI Cmds â”‚       â”‚CLI Cmds â”‚       â”‚CLI Cmdsâ”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  External Plugins (npm packages / local dirs)   â”‚  â”‚
â”‚  â”‚  @pabawi-plugins/ansible                        â”‚  â”‚
â”‚  â”‚  @pabawi-plugins/terraform                      â”‚  â”‚
â”‚  â”‚  backend/src/integrations/custom-plugin/        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Plugin Structure

Every plugin can provide:

1. **Backend Capabilities**: Functions that perform actions (execute commands, query data, compile configs)
2. **Frontend Widgets**: Svelte components that render in UI slots
3. **CLI Commands**: Command definitions with argument schemas

```
@pabawi-plugins/example/
â”œâ”€â”€ package.json                   # Plugin metadata
â”œâ”€â”€ backend/
â”‚   â””â”€â”€ index.ts                   # createPlugin() export
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.ts                   # Widget exports
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ ExampleWidget.svelte
â”‚   â”‚   â””â”€â”€ ExamplePanel.svelte
â”‚   â””â”€â”€ stores/
â”‚       â””â”€â”€ exampleState.svelte.ts
â””â”€â”€ cli/
    â””â”€â”€ commands.ts                # CLI command definitions (optional)
```

## Implementation Steps

### Phase 1: Core Plugin Infrastructure (Weeks 1-2)

#### Step 1: Define Enhanced Plugin Interfaces âœ… COMPLETED

**File:** `backend/src/integrations/types.ts`

**Status:** Completed 2026-01-31

**Actions Completed:**

- âœ… Kept deprecated `ExecutionToolPlugin` and `InformationSourcePlugin` interfaces (for backward compatibility, marked deprecated)
- âœ… Defined `PluginMetadata` interface (with additional fields: `integrationType`, `color`, `icon`, `minPabawiVersion`, `tags`):

  ```typescript
  interface PluginMetadata {
    name: string;
    version: string;
    author: string;
    description: string;
    homepage?: string;
    dependencies?: string[];        // Other plugin dependencies
    frontendEntryPoint?: string;    // Path to frontend bundle
    cliCommands?: PluginCLICommand[];
  }
  ```

- âœ… Defined `PluginCapability` interface (with `CapabilityCategory` type for standard categories):

  ```typescript
  interface PluginCapability {
    category: string;                // 'command', 'task', 'facts', 'config'
    name: string;                    // 'command.execute'
    description: string;
    handler: (params: any, context: ExecutionContext) => Promise<any>;
    requiredPermissions: string[];
    riskLevel: 'read' | 'write' | 'execute' | 'admin';
    schema?: CapabilitySchema;       // Zod schema for validation
  }
  
  interface CapabilitySchema {
    arguments: Record<string, ArgumentDefinition>;
    returns: {
      type: string;
      description: string;
      schema?: ZodSchema;
    };
  }
  
  interface ArgumentDefinition {
    type: 'string' | 'number' | 'boolean' | 'array' | 'object';
    description: string;
    required: boolean;
    default?: any;
    choices?: any[];
    validation?: ZodSchema;
  }
  ```

- âœ… Defined `PluginWidget` interface (with additional fields: `icon`, `priority`):

  ```typescript
  interface PluginWidget {
    id: string;                      // 'bolt:command-executor'
    name: string;
    component: string;               // Component path
    slots: WidgetSlot[];             // Where it can render
    size: 'small' | 'medium' | 'large' | 'full';
    requiredCapabilities: string[];  // For permission checks
    config?: Record<string, unknown>;
  }
  
  type WidgetSlot = 
    | 'dashboard' 
    | 'node-detail' 
    | 'inventory-panel' 
    | 'standalone-page';
  ```

- âœ… Defined `PluginCLICommand` interface:

  ```typescript
  interface PluginCLICommand {
    name: string;                    // 'bolt', 'puppetdb'
    actions: CLIAction[];
  }
  
  interface CLIAction {
    name: string;                    // 'run', 'query'
    capability: string;              // Maps to capability name
    description: string;
    aliases?: string[];
    examples?: string[];
  }
  ```

- âœ… Expanded `IntegrationType` enum (added `InstallSoftware`, `Info`):

  ```typescript
  enum IntegrationType {
    Provisioning = 'Provisioning',
    ConfigurationManagement = 'ConfigurationManagement',
    InventorySource = 'InventorySource',
    RemoteExecution = 'RemoteExecution',
    Monitoring = 'Monitoring',
    Orchestration = 'Orchestration',
    SecretManagement = 'SecretManagement', #pragma: allowlist secret
    ReportingAnalytics = 'ReportingAnalytics',
    AuditCompliance = 'AuditCompliance',
    BackupRecovery = 'BackupRecovery'
  }
  ```

- âœ… Defined unified `BasePluginInterface` (with optional `shutdown()` method):

  ```typescript
  interface BasePluginInterface {
    metadata: PluginMetadata;
    capabilities: PluginCapability[];
    widgets?: PluginWidget[];
    cliCommands?: PluginCLICommand[];
    configSchema?: ZodSchema;
    defaultPermissions?: Record<string, string[]>;  // capability -> roles
    
    initialize(): Promise<void>;
    healthCheck(): Promise<HealthCheckResult>;
    getConfig(): Record<string, unknown>;
    isInitialized(): boolean;
  }
  ```

#### Step 2: Build Capability Registry âœ… COMPLETED

**File:** `backend/src/integrations/CapabilityRegistry.ts`

**Status:** Completed 2026-01-31

**Actions Completed:**

- âœ… Created registry mapping capability names to plugin handlers (753 lines)
- âœ… Implemented methods:
  - `registerCapability(pluginName: string, capability: PluginCapability)`
  - `getProvidersForCapability(capabilityName: string): RegisteredCapability[]`
  - `getAllCapabilities(user?: User, options?): RegisteredCapability[]` (permission-filtered)
  - `executeCapability<T>(user: User, capabilityName: string, params: any, debugContext?: DebugContext): Promise<CapabilityExecutionResult<T>>`
  - `getPrimaryProvider(capabilityName: string): RegisteredCapability | undefined`
  - `unregisterPlugin(pluginName: string): number`
- âœ… Support priority-based routing when multiple plugins provide same capability
- âœ… Widget registration and capability linking:
  - `registerWidget(pluginName: string, widget: PluginWidget)`
  - `getAllWidgets(user?: User, slot?: string): RegisteredWidget[]`
  - `getWidgetsForCapability(capabilityName: string): RegisteredWidget[]`
- âœ… Helper methods: `getCapabilitiesByCategory()`, `getCapabilitiesByRiskLevel()`, `getStats()`

#### Step 3: Implement Plugin Loader âœ… COMPLETED

**File:** `backend/src/integrations/PluginLoader.ts`

**Status:** Completed 2026-01-31

**Actions Completed:**

- âœ… Scan directories: `backend/src/integrations/` and `node_modules/@pabawi-plugins/*/` (943 lines)
- âœ… Load plugins via dynamic `import()` with factory pattern support
- âœ… Validate plugin structure against interfaces (comprehensive validation)
- âœ… Resolve dependency graph with Kahn's algorithm (topological sort)
- âœ… Extract frontend metadata and CLI definitions
- âœ… Return loaded plugin instances with metadata

**Key Methods Implemented:**

- âœ… `async loadAll(): Promise<LoadedPlugin[]>` - Load all discovered plugins
- âœ… `async loadPlugin(path: string): Promise<LoadedPlugin | null>` - Load single plugin
- âœ… `validatePlugin(plugin: BasePluginInterface): PluginValidationResult` - Validate plugin structure
- âœ… `resolveDependencies(plugins: LoadedPlugin[]): LoadedPlugin[]` - Topological sort
- âœ… `async discover(): Promise<PluginDiscoveryResult[]>` - Discover plugins without loading
- âœ… `async reloadPlugin(name: string): Promise<LoadedPlugin | null>` - Hot-reload support
- âœ… `getPlugin(name: string): LoadedPlugin | undefined` - Get loaded plugin
- âœ… `getAllPlugins(): Map<string, LoadedPlugin>` - Get all loaded plugins

**Additional Features:**

- Plugin factory function support (`createPlugin()`, `default`, `Plugin` class)
- Circular dependency detection with error reporting
- Validation warnings for non-fatal issues
- Configurable strict validation mode
- Skip plugins configuration

#### Step 4: Refactor Integration Manager âœ… COMPLETED

**File:** `backend/src/integrations/IntegrationManager.ts`

**Status:** Completed 2026-01-31

**Breaking Changes (Implemented as Deprecations):**

- âœ… Marked `executionTools` and `informationSources` Maps as deprecated
- âœ… Legacy methods (`getExecutionTool`, `getInformationSource`, etc.) now log deprecation warnings
- âœ… Added capability-based routing via `executeCapability()`

**New Architecture (Implemented):**

- âœ… Uses `CapabilityRegistry` for all capability-based operations
- âœ… Uses `PluginLoader` for v1.0.0 plugin discovery and loading
- âœ… `initializePlugins()` now initializes both legacy and v1.0.0 plugins
- âœ… Added `getInventoryViaCapability()` for capability-based inventory access
- âœ… Added `getNodeFactsViaCapability()` for capability-based facts access

**Updated Methods:**

- âœ… `async initializePlugins(options?)`: Supports both legacy and v1.0.0 plugin loading
- âœ… `async executeCapability(user, capabilityName, params, debugContext)`: Routes to CapabilityRegistry
- âœ… `getPluginMetadata(pluginName)`: Returns plugin metadata
- âœ… `async reloadPlugin(pluginName)`: Hot-reload support

**Deprecated (will be removed in v2.0.0):**

- `getExecutionTool()` - Use `executeCapability('command.execute', ...)`
- `getInformationSource()` - Use `executeCapability('inventory.list', ...)`
- `getAllExecutionTools()` - Use `getCapabilitiesByCategory('command')`
- `getAllInformationSources()` - Use `getCapabilitiesByCategory('inventory')`

#### Step 5: Create Database Abstraction Layer âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/database/interfaces/DatabaseInterface.ts` - Core interfaces
- âœ… `backend/src/database/adapters/SQLiteAdapter.ts` - SQLite implementation
- âœ… `backend/src/database/DatabaseFactory.ts` - Adapter factory
- âœ… `backend/src/database/index.ts` - Barrel exports
- ðŸ”® `backend/src/database/adapters/PostgreSQLAdapter.ts` (future)

**Actions Completed:**

- âœ… Defined `DatabaseAdapter` interface with connection, transaction, query, and schema methods
- âœ… Defined `DatabaseConfig` interface supporting SQLite, PostgreSQL, MySQL
- âœ… Implemented `SQLiteAdapter` with full interface compliance
- âœ… Created `DatabaseFactory` for adapter instantiation
- âœ… Updated `DatabaseService` to use adapter pattern (with backward compatibility)
- âœ… Added `DatabaseConfigSchema` to config/schema.ts
- âœ… Updated `AppConfigSchema` with optional `database` configuration
- âœ… Maintained backward compatibility with legacy `databasePath` string option
- âœ… `ExecutionRepository` continues to work via `getConnection()` deprecation bridge

**Breaking Changes:** None (fully backward compatible)

**New Capabilities:**

- Transaction support (`beginTransaction`, `commit`, `rollback`, `withTransaction`)
- Health checks (`healthCheck()`)
- Database dialect awareness (`getDialect()`)
- Migration framework with versioning
- Extensible adapter registration for plugins

**Database Interface Summary:**

```typescript
export interface DatabaseAdapter {
  // Connection management
  connect(): Promise<void>;
  disconnect(): Promise<void>;
  isConnected(): boolean;
  
  // Transaction support
  beginTransaction(): Promise<void>;
  commit(): Promise<void>;
  rollback(): Promise<void>;
  
  // Query execution
  query<T>(sql: string, params?: any[]): Promise<T[]>;
  execute(sql: string, params?: any[]): Promise<{ changes: number; lastID?: number }>;
  
  // Schema management
  migrate(migrations: Migration[]): Promise<void>;
  getCurrentVersion(): Promise<number>;
  
  // Utility methods
  escape(value: any): string;
  getDialect(): 'sqlite' | 'postgresql' | 'mysql';
}

export interface Migration {
  version: number;
  name: string;
  up: string;
  down: string;
}

export interface DatabaseConfig {
  type: 'sqlite' | 'postgresql' | 'mysql';
  // SQLite
  path?: string;
  // PostgreSQL/MySQL
  host?: string;
  port?: number;
  database?: string;
  username?: string;
  password?: string;
  ssl?: boolean;
  // Common
  poolMin?: number;
  poolMax?: number;
  connectionTimeout?: number;
}
```

**SQLiteAdapter.ts** - Current implementation:

```typescript
export class SQLiteAdapter implements DatabaseAdapter {
  private db: Database | null = null;
  
  constructor(private config: DatabaseConfig) {}
  
  async connect(): Promise<void> {
    this.db = new Database(this.config.path);
    // Enable foreign keys, WAL mode, etc.
  }
  
  async query<T>(sql: string, params?: any[]): Promise<T[]> {
    return this.db.prepare(sql).all(params);
  }
  
  async execute(sql: string, params?: any[]): Promise<{ changes: number; lastID?: number }> {
    const result = this.db.prepare(sql).run(params);
    return { changes: result.changes, lastID: result.lastInsertRowid };
  }
  
  getDialect(): 'sqlite' { return 'sqlite'; }
  
  // ... other methods
}
```

**DatabaseFactory.ts** - Adapter selection:

```typescript
export class DatabaseFactory {
  static create(config: DatabaseConfig): DatabaseAdapter {
    switch (config.type) {
      case 'sqlite':
        return new SQLiteAdapter(config);
      case 'postgresql':
        // Future: return new PostgreSQLAdapter(config);
        throw new Error('PostgreSQL adapter not yet implemented');
      default:
        throw new Error(`Unsupported database type: ${config.type}`);
    }
  }
}
```

**Update DatabaseService.ts:**

```typescript
export class DatabaseService {
  private adapter: DatabaseAdapter;
  
  constructor(config: DatabaseConfig) {
    this.adapter = DatabaseFactory.create(config);
  }
  
  async initialize() {
    await this.adapter.connect();
    await this.runMigrations();
  }
  
  // Delegate all operations to adapter
  async query<T>(sql: string, params?: any[]): Promise<T[]> {
    return this.adapter.query<T>(sql, params);
  }
  
  // ... other methods
}
```

**Configuration support in schema.ts:**

```typescript
const DatabaseConfigSchema = z.object({
  type: z.enum(['sqlite', 'postgresql', 'mysql']).default('sqlite'),
  path: z.string().optional(),  // SQLite
  host: z.string().optional(),  // PostgreSQL/MySQL
  port: z.number().optional(),
  database: z.string().optional(),
  username: z.string().optional(),
  password: z.string().optional(),
  ssl: z.boolean().optional(),
  poolMin: z.number().default(2),
  poolMax: z.number().default(10),
});
```

**Benefits:**

- **Current:** SQLite works as-is with minimal changes
- **Future:** Easy to add PostgreSQL, MySQL, or other databases
- **Abstraction:** All database-specific code isolated in adapters
- **Migration:** Query builders can be database-aware (handle syntax differences)
- **Testing:** Mock adapter for unit tests

### Phase 2: Authentication & Authorization (Week 3)

#### Step 6: Create User Management System âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/auth/types.ts` - Core type definitions
- âœ… `backend/src/auth/UserService.ts` - User account CRUD
- âœ… `backend/src/auth/GroupService.ts` - Group management CRUD
- âœ… `backend/src/auth/RoleService.ts` - Role and permission management
- âœ… `backend/src/auth/index.ts` - Barrel exports
- âœ… `backend/src/database/schema.sql` - Added auth tables

**Actions Completed:**

- âœ… Defined comprehensive type models:
  - `User`, `UserPublic`, `CreateUserInput`, `UpdateUserInput`
  - `Group`, `CreateGroupInput`, `UpdateGroupInput`
  - `Role`, `CreateRoleInput`, `UpdateRoleInput`
  - `Permission`, `PermissionAction`, `PermissionCondition`
  - `EffectivePermissions`, `PermissionCheckResult`
  - `PaginationOptions`, `PaginatedResult<T>` for list queries
  - Built-in role constants (`admin`, `operator`, `viewer`, `anonymous`)

- âœ… Implemented UserService with:
  - bcrypt password hashing (12 salt rounds)
  - CRUD operations (create, read, update, delete)
  - User lookup by ID, username, email
  - Password verification and last login tracking
  - Pagination and search support

- âœ… Implemented GroupService with:
  - CRUD operations for groups
  - Member management (add/remove users)
  - Role assignment to groups
  - Group lookup by ID and name
  - Pagination and search support

- âœ… Implemented RoleService with:
  - Built-in system roles initialization
  - CRUD operations (with protection for system roles)
  - Permission management (add/remove)
  - Capability pattern matching (`*`, `*.action`, exact match)
  - Effective roles calculation (user + group roles)

- âœ… Created database schema with:
  - `users` table with password hash, active flag, timestamps
  - `groups` table with name, description
  - `roles` table with priority, is_system flag
  - `permissions` table with capability patterns, conditions (JSON)
  - Junction tables: `user_groups`, `user_roles`, `group_roles`
  - Comprehensive indexes for efficient queries

- âœ… Added `bcrypt` dependency for password hashing

**Key Features:**

- **Priority-based role resolution:** Higher priority roles win in permission conflicts
- **Capability patterns:** Support for wildcards (`*`, `inventory.*`)
- **Conditional permissions:** Node filters, time windows, IP restrictions
- **Default permissions:** Built-in roles have sensible defaults
- **System role protection:** Cannot delete or rename system roles
- **Structured logging:** All operations logged with component/operation metadata

**Original Specification (for reference):**

- Define models:

  ```typescript
  interface User {
    id: string;
    username: string;
    email: string;
    passwordHash: string;
    groups: string[];
    roles: string[];
    active: boolean;
    createdAt: Date;
  }
  
  interface Group {
    id: string;
    name: string;
    description: string;
    roles: string[];
    members: string[];
    createdAt: Date;
  }
  
  interface Role {
    id: string;
    name: string;
    description: string;
    permissions: Permission[];
    priority: number;
    createdAt: Date;
  }
  
  interface Permission {
    capability: string;              // 'command.execute' or '*'
    action: 'allow' | 'deny';
    conditions?: PermissionCondition;
  }
  
  interface PermissionCondition {
    nodeFilter?: string;             // 'environment=dev'
    timeWindow?: string;
    ipRestriction?: string[];
  }
  ```

- Create database schema in `backend/src/database/schema.sql`:

  ```sql
  CREATE TABLE users (
    id TEXT PRIMARY KEY,
    username TEXT UNIQUE NOT NULL,
    email TEXT UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    active INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE TABLE groups (
    id TEXT PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE TABLE roles (
    id TEXT PRIMARY KEY,
    name TEXT UNIQUE NOT NULL,
    description TEXT,
    priority INTEGER DEFAULT 0,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
  );
  
  CREATE TABLE permissions (
    id TEXT PRIMARY KEY,
    role_id TEXT NOT NULL,
    capability TEXT NOT NULL,
    action TEXT NOT NULL,  -- 'allow' or 'deny'
    conditions TEXT,       -- JSON
    FOREIGN KEY (role_id) REFERENCES roles(id)
  );
  
  CREATE TABLE user_groups (
    user_id TEXT NOT NULL,
    group_id TEXT NOT NULL,
    PRIMARY KEY (user_id, group_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (group_id) REFERENCES groups(id)
  );
  
  CREATE TABLE user_roles (
    user_id TEXT NOT NULL,
    role_id TEXT NOT NULL,
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
  );
  
  CREATE TABLE group_roles (
    group_id TEXT NOT NULL,
    role_id TEXT NOT NULL,
    PRIMARY KEY (group_id, role_id),
    FOREIGN KEY (group_id) REFERENCES groups(id),
    FOREIGN KEY (role_id) REFERENCES roles(id)
  );
  ```

- Implement services with bcrypt password hashing, CRUD operations

#### Step 7: Build Authentication Service âœ… COMPLETED

**Status:** Completed 2026-01-31

**File:** `backend/src/auth/AuthService.ts`

**Actions Completed:**

- âœ… Implemented JWT-based authentication with `jsonwebtoken` library
- âœ… Methods implemented:
  - `authenticate(username, password)` â†’ `AuthTokens`
  - `validateToken(token)` â†’ `ValidatedToken`
  - `refreshToken(refreshToken)` â†’ `AuthTokens`
  - `revokeToken(token, reason?)` â†’ void
  - `revokeAllUserTokens(userId, reason?)` â†’ void
  - `generateTokens(user)` â†’ `AuthTokens`
  - `getActiveSessionCount(userId)` â†’ number
  - `cleanupExpiredTokens()` â†’ number (for maintenance)

- âœ… Token structure implemented:

  ```typescript
  interface AuthTokens {
    accessToken: string;   // Short-lived (1 hour default)
    refreshToken: string;  // Long-lived (7 days default)
    tokenType: "Bearer";
    expiresIn: number;
    refreshExpiresIn: number;
  }

  interface JWTAccessPayload {
    type: "access";
    userId: string;
    username: string;
    roles: string[];
    groups: string[];
    jti: string;  // Token ID for revocation
    iat: number;
    exp: number;
  }
  ```

- âœ… Database tables for token management:
  - `refresh_tokens` - Tracks issued refresh tokens
  - `token_revocations` - Revocation list with expiry cleanup

- âœ… Security features:
  - Token revocation list with automatic cleanup
  - Refresh token rotation (old token revoked on refresh)
  - Account disabled check on validation
  - Configurable token expiry times

#### Step 8: Implement Authorization Service âœ… COMPLETED

**Status:** Completed 2026-01-31

**File:** `backend/src/auth/AuthorizationService.ts`

**Actions Completed:**

- âœ… Core method: `checkPermission(user, capability, context?)` â†’ `PermissionCheckResult`
- âœ… Algorithm implemented:
  1. Resolve user's effective roles (direct + via groups)
  2. Collect all permissions from those roles
  3. Sort by priority (deny > allow, specific > wildcard)
  4. Evaluate conditions (node filters, time windows, IP restrictions)
  5. Return true if allowed, false otherwise

- âœ… Helper methods implemented:
  - `getEffectivePermissions(user)` â†’ `EffectivePermissions`
  - `checkWidgetAccess(user, requiredCapabilities)` â†’ `WidgetAccessResult`
  - `filterCapabilitiesByPermissions(capabilities, user)` â†’ filtered capabilities
  - `invalidateCache(userId)` / `invalidateAllCaches()` - Cache management

- âœ… Permission caching with configurable TTL (default: 5 minutes)
- âœ… Cache invalidation on role/permission changes

- âœ… Capability pattern matching:
  - `*` matches everything
  - `category.*` matches all capabilities in category
  - `category.action` exact match

- âœ… Conditional permission evaluation:
  - Node filters: `environment=production`, `role=webserver`, `name~web*`
  - Time windows: `weekdays:09:00-17:00`, `weekend:00:00-23:59`
  - IP restrictions: exact match, CIDR ranges, wildcards

#### Step 9: Add Authentication Middleware âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/middleware/auth.ts` - JWT authentication middleware
- âœ… `backend/src/middleware/rbac.ts` - RBAC authorization middleware

**auth.ts Features:**

- `createAuthMiddleware(config)` - Factory for auth middleware
- `requireAuth(config)` - Shorthand for required authentication
- `optionalAuth(config)` - For routes with optional auth
- Extracts Bearer token from Authorization header
- Validates token and attaches user to request
- Extends Express Request with `user` and `isAuthenticated` properties

**rbac.ts Features:**

- `initializeRbac(config)` - Initialize shared authorization service
- `requireCapability(capability, options)` - Single capability check
- `requireAnyCapability(capabilities, options)` - Any of multiple capabilities
- `requireAllCapabilities(capabilities, options)` - All capabilities required
- `requireAdmin(options)` - Shorthand for admin access
- Automatic execution context extraction from request
- Node/target detection from params, query, or body
- Cache invalidation helpers

#### Step 10: Create Auth Routes âœ… COMPLETED

**Status:** Completed 2026-01-31

**File:** `backend/src/routes/auth.ts`

**Endpoints Implemented:**

- âœ… `POST /api/auth/login` - Username/password â†’ tokens + user
- âœ… `POST /api/auth/refresh` - Refresh token â†’ new tokens
- âœ… `POST /api/auth/logout` - Revoke tokens (single or all sessions)
- âœ… `GET /api/auth/me` - Current user + effective permissions
- âœ… `GET /api/auth/sessions` - Active session count
- âœ… `POST /api/auth/check` - Check specific capability permission

**Features:**

- Expert mode support with debug info attachment
- Structured logging for all operations
- Proper error handling with specific error codes
- Input validation

#### Step 11: Create RBAC Management Routes âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/routes/users.ts` - User management routes
- âœ… `backend/src/routes/groups.ts` - Group management routes
- âœ… `backend/src/routes/roles.ts` - Role management routes

**Actions Completed:**

- âœ… Implemented CRUD endpoints for users, groups, roles
- âœ… All routes require admin role via `requireAdmin()` middleware
- âœ… Expert mode support with debug info attachment
- âœ… Structured logging for all operations
- âœ… Proper error handling with specific error codes
- âœ… Cache invalidation on permission-affecting changes

**User Routes (`/api/users`):**

- `GET /` - List users (paginated)
- `GET /search` - Search users by username/email/displayName
- `GET /:id` - Get user by ID
- `POST /` - Create user
- `PUT /:id` - Update user
- `DELETE /:id` - Delete user (prevents self-deletion)
- `GET /:id/groups` - Get user's groups
- `GET /:id/roles` - Get user's effective roles

**Group Routes (`/api/groups`):**

- `GET /` - List groups (paginated)
- `GET /search` - Search groups
- `GET /:id` - Get group by ID
- `POST /` - Create group
- `PUT /:id` - Update group
- `DELETE /:id` - Delete group
- `GET /:id/members` - Get group members
- `GET /:id/roles` - Get group roles
- `POST /:id/members/:userId` - Add member to group
- `DELETE /:id/members/:userId` - Remove member from group
- `POST /:id/roles/:roleId` - Add role to group
- `DELETE /:id/roles/:roleId` - Remove role from group

**Role Routes (`/api/roles`):**

- `GET /` - List roles (paginated)
- `GET /search` - Search roles
- `GET /:id` - Get role by ID
- `POST /` - Create role
- `PUT /:id` - Update role (protects system roles)
- `DELETE /:id` - Delete role (prevents system role deletion)
- `POST /:id/permissions` - Add permission to role
- `DELETE /:id/permissions/:capability` - Remove permission from role
- `GET /:id/users` - Get users with this role
- `GET /:id/groups` - Get groups with this role
- `POST /initialize` - Initialize built-in system roles

### Phase 3: Configuration System (Week 4)

#### Step 12: Build YAML Configuration Support âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/config/YamlConfigLoader.ts` - YAML parsing and env var interpolation
- âœ… `backend/src/config/index.ts` - Barrel exports for config module
- âœ… `backend/config/integrations.yaml.example` - Integration configuration template
- âœ… `backend/config/rbac.yaml.example` - RBAC configuration template
- âœ… `backend/config/database.yaml.example` - Database configuration template
- âœ… `backend/test/unit/YamlConfigLoader.test.ts` - Unit tests (24 passing)

**Actions Completed:**

- âœ… Added YAML parsing with `yaml` package (already installed)
- âœ… Created `YamlConfigLoader` class with comprehensive features:
  - `loadFile<T>()` - Load and parse YAML with type safety
  - `loadFileOrEmpty()` - Load with fallback to empty object
  - `loadAndMerge()` - Merge multiple config files (later overrides earlier)
  - `loadFirst()` - Load first existing file from list
  - `fileExists()` / `getResolvedPath()` - Path utilities
  - `writeFile()` - Write config with optional comment header

- âœ… Implemented environment variable interpolation:
  - `${VAR_NAME}` - Required variable (placeholder preserved if missing)
  - `${VAR_NAME:-default}` - Variable with default value
  - `${VAR_NAME:?error message}` - Custom error if missing (throws)
  - Supports nested interpolation in objects and arrays
  - Tracks interpolated and missing variables

- âœ… Integrated with `ConfigService`:
  - `loadYamlConfigs()` - Loads integrations, rbac, database configs
  - `getYamlConfig()` - Returns loaded YAML configuration
  - `getRbacConfig()` - Returns RBAC configuration from YAML
  - `hasYamlConfig()` - Check if specific config was loaded
  - `reloadYamlConfigs()` - Hot-reload configuration files

- âœ… Configuration precedence implemented: CLI args > env vars > YAML > defaults

**Default Config File Paths:**

```typescript
DEFAULT_CONFIG_PATHS = {
  integrations: ["config/integrations.yaml", "config/integrations.yml", ...],
  rbac: ["config/rbac.yaml", "config/rbac.yml", ...],
  database: ["config/database.yaml", "config/database.yml", ...],
  main: ["config/pabawi.yaml", "config/pabawi.yml", ...],
}
```

**Example YAML Files Created:**

- `integrations.yaml.example` - Full Bolt, PuppetDB, Puppetserver, Hiera config
- `rbac.yaml.example` - Auth settings, role definitions, permission templates
- `database.yaml.example` - SQLite (default), PostgreSQL and MySQL templates

#### Step 13: Create Configuration Schemas âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `backend/src/config/SchemaRegistry.ts` - Schema registry for plugin configurations
- âœ… `backend/src/config/YamlConfigSchemas.ts` - Comprehensive YAML validation schemas
- âœ… `backend/test/unit/SchemaRegistry.test.ts` - Unit tests (24 tests)
- âœ… `backend/test/unit/YamlConfigSchemas.test.ts` - Unit tests (37 tests)
- âœ… Updated `backend/src/config/index.ts` - Barrel exports

**Actions Completed:**

- âœ… Created `SchemaRegistry` class for centralized schema management:
  - Singleton pattern with `getSchemaRegistry()` / `resetSchemaRegistry()`
  - Schema registration with metadata (id, name, description, version, category)
  - Per-plugin schema registration with `registerPluginSchema()`
  - Core schema registration with `registerCoreSchema()`
  - Schema retrieval by ID, category, plugin name
  - Schema validation with detailed error reporting
  - Schema composition for merging multiple schemas
  - Plugin schema unregistration (`unregisterPlugin()`)
  - Statistics and metadata export for documentation

- âœ… Defined Zod schemas for `integrations.yaml` validation:
  - `IntegrationsYamlSchema` - Complete integrations.yaml structure
  - `YamlBoltIntegrationSchema` - Bolt plugin configuration
  - `YamlPuppetDBIntegrationSchema` - PuppetDB plugin configuration
  - `YamlPuppetserverIntegrationSchema` - Puppetserver plugin configuration
  - `YamlHieraIntegrationSchema` - Hiera plugin configuration
  - `YamlExternalPluginSchema` - External/third-party plugin configuration
  - `YamlWidgetConfigSchema` - Frontend widget configuration
  - `YamlFrontendConfigSchema` - Frontend integration configuration
  - `DefaultPermissionsSchema` - Capability to roles mapping

- âœ… Defined Zod schemas for `rbac.yaml` validation:
  - `RbacYamlSchema` - Complete rbac.yaml structure
  - `YamlAuthConfigSchema` - Authentication configuration
  - `YamlJWTConfigSchema` - JWT token settings
  - `YamlSessionConfigSchema` - Session management settings
  - `YamlPasswordPolicySchema` - Password policy rules
  - `YamlRoleSchema` - Role definition with permissions
  - `YamlPermissionSchema` - Permission with capability pattern and conditions
  - `YamlPermissionConditionSchema` - Node filters, time windows, IP restrictions
  - `YamlGroupSchema` - Group definition with roles
  - `YamlUserSchema` - User seed data with email validation

- âœ… Defined Zod schemas for `database.yaml` validation:
  - `DatabaseYamlSchema` - Complete database.yaml structure
  - `YamlMigrationConfigSchema` - Migration settings (autoRun, directory)
  - `YamlBackupConfigSchema` - Backup settings (schedule, retention)

- âœ… Created combined schema `PabawiYamlConfigSchema` for all YAML configs

- âœ… Implemented validation helpers:
  - `validateIntegrationsYaml(data)` - Validate integrations config
  - `validateRbacYaml(data)` - Validate RBAC config
  - `validateDatabaseYaml(data)` - Validate database config
  - `validatePabawiConfig(data)` - Validate combined config

- âœ… Implemented schema registration function:
  - `registerYamlConfigSchemas()` - Register all YAML schemas in registry

- âœ… Updated barrel exports with all new types and functions

**Test Results:** 61 tests passing (24 SchemaRegistry + 37 YamlConfigSchemas)

**Schema Categories:**

| Category | Description | Schemas |
|----------|-------------|---------|
| `core` | Core application schemas | `yaml:pabawi` |
| `integration` | Integration plugin configs | `yaml:integrations`, `yaml:integrations:bolt`, `yaml:integrations:puppetdb`, `yaml:integrations:puppetserver`, `yaml:integrations:hiera` |
| `auth` | Authentication/RBAC | `yaml:rbac`, `yaml:rbac:auth`, `yaml:rbac:role`, `yaml:rbac:permission` |
| `database` | Database configuration | `yaml:database` |
| `plugin` | Plugin-specific schemas | (registered by plugins) |
| `custom` | User-defined schemas | (runtime registration) |

**Usage Example:**

```typescript
import {
  validateIntegrationsYaml,
  registerPluginSchema,
  getSchemaRegistry,
} from './config';

// Validate YAML config
const result = validateIntegrationsYaml(loadedConfig);
if (!result.success) {
  console.error('Invalid config:', result.error.format());
}

// Register plugin-specific schema
registerPluginSchema('my-plugin', mySchema, {
  id: 'plugin:my:config',
  name: 'My Plugin Config',
  description: 'Configuration for my plugin',
  version: '1.0.0',
  category: 'plugin',
});

// Validate using registry
const registry = getSchemaRegistry();
const validation = registry.validate('plugin:my:config', data);
```

#### Step 14: Create Example YAML Configs âœ… COMPLETED (merged into Step 12)

**Status:** Completed as part of Step 12

**Files Created (see Step 12 for details):**

- âœ… `backend/config/integrations.yaml.example`
- âœ… `backend/config/rbac.yaml.example`
- âœ… `backend/config/database.yaml.example`

### Phase 4: Frontend Plugin System (Weeks 5-6)

#### Step 15: Create Frontend Plugin Loader âœ… COMPLETED

**Status:** Completed 2026-01-31

**Files Created:**

- âœ… `frontend/src/lib/plugins/types.ts` - Frontend plugin type definitions
- âœ… `frontend/src/lib/plugins/PluginLoader.ts` - Plugin loading and management
- âœ… `frontend/src/lib/plugins/index.ts` - Barrel exports

**Actions Completed:**

- âœ… Created comprehensive type definitions (`types.ts`):
  - `PluginWidget`, `LoadedWidget`, `WidgetLoadState` - Widget types
  - `PluginInfo`, `LoadedPlugin`, `PluginLoadState` - Plugin types
  - `PluginMetadata`, `PluginCapabilitySummary` - Metadata types
  - `PluginFrontendModule` - Module export interface
  - `PluginEvent`, `PluginEventHandler` - Event types
  - `PluginLoaderConfig`, `DEFAULT_PLUGIN_LOADER_CONFIG` - Configuration
  - `WidgetValidationResult`, `PluginValidationResult` - Validation types
  - `IntegrationType` enum mirroring backend

- âœ… Implemented `PluginLoader` class with:
  - `loadAll()` - Load all available plugins from backend API
  - `loadPlugin(name)` - Load a specific plugin by name
  - `reloadPlugin(name)` - Reload plugin with fresh metadata
  - `unloadPlugin(name)` - Unload and cleanup plugin
  - `getPlugin(name)` / `getAllPlugins()` - Retrieve loaded plugins
  - `getWidgetsForSlot(slot, userCapabilities?)` - Get widgets for a slot with permission filtering
  - `getWidgetComponent(widgetId)` - Get cached widget component
  - `loadWidgetComponent(widgetId)` - Lazy load widget component
  - `validatePlugin(info)` - Validate plugin and widget definitions
  - `subscribe(handler)` - Subscribe to plugin lifecycle events
  - `clearAll()` - Clear all caches and cleanup

- âœ… Dynamic import system features:
  - Lazy widget loading (configurable)
  - Plugin module loading with initialization hooks
  - Retry logic with exponential backoff
  - Component caching for performance

- âœ… Error handling:
  - Graceful degradation on load failures
  - Partial load states for plugins with some failed widgets
  - Detailed error messages in LoadedWidget/LoadedPlugin
  - Event emission for error tracking

- âœ… Validation:
  - Widget ID format validation (pluginName:widgetName)
  - Required field checks (id, name, component, slots)
  - Slot name validation
  - Warnings for non-fatal issues

- âœ… Caching:
  - Plugin metadata caching with configurable TTL
  - Widget component caching
  - Plugin module caching
  - Request deduplication for concurrent loads

- âœ… Singleton pattern with `getPluginLoader()` / `resetPluginLoader()`

**Configuration Options:**

```typescript
interface PluginLoaderConfig {
  apiBaseUrl: string;        // Default: "/api"
  assetsBaseUrl: string;     // Default: "/plugins"
  lazyLoadWidgets: boolean;  // Default: true
  metadataCacheTTL: number;  // Default: 60000 (1 minute)
  maxRetries: number;        // Default: 3
  retryDelay: number;        // Default: 1000ms
  debug: boolean;            // Default: false
}
```

**Usage Example:**

```typescript
import { getPluginLoader } from '$lib/plugins';

// Get the plugin loader
const loader = getPluginLoader({ debug: true });

// Subscribe to events
const unsubscribe = loader.subscribe((event) => {
  console.log('Plugin event:', event.type);
});

// Load all plugins
const plugins = await loader.loadAll();

// Get widgets for dashboard
const dashboardWidgets = loader.getWidgetsForSlot('dashboard', userCapabilities);

// Lazy load a widget component
const component = await loader.loadWidgetComponent('bolt:command-executor');
```

#### Step 16: Build Widget Registry âœ… COMPLETED

**Status:** Completed 2026-01-31

**File:** `frontend/src/lib/plugins/WidgetRegistry.svelte.ts`

**Actions Completed:**

- âœ… Created centralized widget registry with Svelte 5 reactive state (`$state()`)
- âœ… Implemented permission-based widget filtering with wildcard capability matching
- âœ… Support slot-based widget retrieval with `getWidgetsForSlot()`
- âœ… Advanced filtering with `getWidgets()` supporting:
  - Filter by slot, plugin name, size, loaded state
  - User capability filtering
  - Capability pattern matching (glob-like)
- âœ… Widget sorting with `getWidgetsSorted()` by priority, name, or plugin
- âœ… Widget registration/unregistration with automatic index management
- âœ… Plugin loader integration with auto-sync on plugin events
- âœ… Event system for registry lifecycle (registered, unregistered, updated, refreshed, cleared)
- âœ… Reactive helpers for Svelte components:
  - `useSlotWidgets(slot, getUserCapabilities)` - Reactive widget list for a slot
  - `usePluginWidgets(pluginName)` - Reactive widget list for a plugin
  - `useWidget(widgetId)` - Reactive single widget
- âœ… Singleton pattern with `getWidgetRegistry()` / `resetWidgetRegistry()`
- âœ… Capability wildcard matching (e.g., "bolt.*" matches "bolt.command")
- âœ… Updated barrel exports in `frontend/src/lib/plugins/index.ts`

**Types Exported:**

```typescript
export interface WidgetFilterOptions {
  slot?: WidgetSlot;
  pluginName?: string;
  size?: WidgetSize;
  userCapabilities?: string[];
  loadedOnly?: boolean;
  capabilityPattern?: string;
  tags?: string[];
}

export interface WidgetSortOptions {
  by: "priority" | "name" | "pluginName";
  direction: "asc" | "desc";
}

export type WidgetRegistryEvent =
  | { type: "widget:registered"; widgetId: string; widget: LoadedWidget }
  | { type: "widget:unregistered"; widgetId: string }
  | { type: "widget:updated"; widgetId: string; widget: LoadedWidget }
  | { type: "registry:refreshed"; widgetCount: number }
  | { type: "registry:cleared" }
  | { type: "registry:error"; error: string };
```

**Usage Example:**

```typescript
import { getWidgetRegistry, useSlotWidgets } from '$lib/plugins';

// Get the widget registry
const registry = getWidgetRegistry();

// Subscribe to events
const unsubscribe = registry.subscribe((event) => {
  console.log('Registry event:', event.type);
});

// Refresh from plugin loader
registry.refresh();

// Get widgets for a slot with permission filtering
const dashboardWidgets = registry.getWidgetsForSlot('dashboard', userCapabilities);

// Advanced filtering
const widgets = registry.getWidgets({
  slot: 'dashboard',
  userCapabilities: ['bolt.*', 'inventory.read'],
  loadedOnly: true,
});

// Check if user can view a widget
const canView = registry.canViewWidget('bolt:command-executor', userCapabilities);

// In Svelte component
const widgets = useSlotWidgets('dashboard', () => userCapabilities);
```

#### Step 17: Create Widget Slot Component

**File:** `frontend/src/lib/plugins/WidgetSlot.svelte`

**Actions:**

- Render widgets in designated slots
- Support different layouts (grid, stack, tabs)
- Lazy load widget components

#### Step 18: Implement Debug Mode

**Files:**

- `frontend/src/lib/debug/debugMode.svelte.ts` (rename from expertMode)
- `frontend/src/lib/debug/useDebugContext.ts`
- `frontend/src/components/DebugPanel.svelte`

**Actions:**

- Rename expert mode to debugMode
- Create debug context per widget
- Track API requests with correlation IDs

#### Step 19: Build Authentication Store

**File:** `frontend/src/lib/auth.svelte.ts`

**Actions:**

- Implement login, logout, token refresh
- Store user and permissions
- Check permissions reactively

#### Step 20: Create Permission Guard Component

**File:** `frontend/src/components/PermissionGuard.svelte`

**Actions:**

- Conditionally render based on capabilities
- Support fallback rendering
- Integrate with auth store

#### Step 21: Build Dynamic Menu System

**File:** `frontend/src/lib/navigation/MenuBuilder.svelte.ts`

**Actions:**

- Generate menu from loaded plugins
- Group by integration type
- Filter by user permissions

#### Step 22: Update Page Components

**Files:**

- `frontend/src/pages/DashboardPage.svelte`
- `frontend/src/pages/InventoryPage.svelte`
- `frontend/src/pages/PluginManagerPage.svelte`
- `frontend/src/pages/LoginPage.svelte`

**Actions:**

- Add widget slots to pages
- Create plugin management UI
- Implement login page

### Phase 5: CLI Application (Week 7)

#### Step 23: Create CLI Workspace Structure

**Actions:**

- Add CLI workspace to root package.json
- Create cli/package.json with dependencies
- Set up TypeScript configuration

#### Step 24: Build CLI Configuration

**File:** `cli/src/config/CliConfig.ts`

**Actions:**

- Use `conf` package for `~/.pabawirc` management
- Store server URL, tokens, preferences
- Support multiple configuration profiles

#### Step 25: Create API Client

**Files:**

- `cli/src/client/ApiClient.ts`
- `cli/src/client/AuthClient.ts`

**Actions:**

- REST API wrapper with authentication
- Auto-refresh expired tokens
- Handle 401/403 responses

#### Step 26: Implement Command Registry

**File:** `cli/src/commands/CommandRegistry.ts`

**Actions:**

- Fetch plugin metadata from server
- Dynamically generate commands from capabilities
- Add arguments from capability schemas
- Route to capability execution

#### Step 27: Create Core Commands

**File:** `cli/src/commands/CoreCommands.ts`

**Actions:**

- `pab login` - Interactive login
- `pab logout` - Clear credentials
- `pab whoami` - Show current user
- `pab config` - Manage configuration
- `pab plugins` - List/show plugins
- `pab capabilities` - List capabilities

#### Step 28: Implement Output Formatters

**File:** `cli/src/formatters/OutputFormatter.ts`

**Actions:**

- Table formatter (cli-table3)
- JSON formatter (pretty-print)
- YAML formatter
- Human-readable formatter

#### Step 29: Build Main CLI Entry Point

**File:** `cli/src/index.ts`

**Actions:**

- Shebang for executable
- Load core commands
- Dynamically load plugin commands
- Handle global options (--debug)

#### Step 30: Add Shell Completions

**Files:**

- `cli/completions/pab.bash`
- `cli/completions/pab.zsh`
- `cli/completions/pab.fish`

**Actions:**

- Generate completion scripts
- Add `pab completion` command
- Installation instructions

### Phase 6: Plugin Migration & Testing (Week 8)

#### Step 31: Migrate Bolt Plugin

**File:** `backend/src/integrations/bolt/index.ts`

**Actions:**

- Remove old interface implementation
- Add metadata, capabilities, widgets, CLI commands
- Create frontend widgets
- Update tests

#### Step 32: Migrate PuppetDB Plugin

**File:** `backend/src/integrations/puppetdb/index.ts`

**Actions:**

- Similar migration to new interface
- Add widgets for reports, events
- Register CLI commands

#### Step 33: Migrate Puppetserver Plugin

**File:** `backend/src/integrations/puppetserver/index.ts`

**Actions:**

- Migrate to new interface
- Add catalog viewer widget

#### Step 34: Migrate Hiera Plugin

**File:** `backend/src/integrations/hiera/index.ts`

**Actions:**

- Migrate to new interface
- Create key explorer widget
- Declare PuppetDB dependency

#### Step 35: Create Example External Plugin

**Directory:** `examples/@pabawi-plugins/ansible/`

**Purpose:** Demonstrate third-party plugin development

**Contents:**

- Complete plugin with backend + frontend + CLI
- Documentation
- Tests

#### Step 36: Comprehensive Testing

**Actions:**

- Unit tests for all new services
- Integration tests for auth flow, plugin loading
- E2E tests for Web UI, API, CLI
- Security tests for RBAC enforcement
- Performance tests for plugin loading
- Database adapter tests

### Phase 7: Documentation & Polish (Week 9)

#### Step 37: Write Documentation

**Files:**

- `docs/plugin-development.md`
- `docs/plugin-frontend-development.md`
- `docs/cli.md`
- `docs/rbac.md`
- `docs/database.md` (new - document database abstraction)
- `docs/configuration.md` (update)
- `docs/migration-guide.md` (0.x â†’ 1.0)

#### Step 38: Create Migration Scripts

**File:** `scripts/migrate-to-v1.sh`

**Actions:**

- Convert env vars to YAML
- Create default admin user
- Backup existing data
- Migrate database schema

#### Step 39: Update Build & CI/CD

**Actions:**

- Update GitHub Actions workflows
- Add CLI build/test steps
- Update Docker images to include CLI
- Multi-arch builds
- Database adapter testing

## Breaking Changes from v0.x

1. **Plugin Interface**: Complete rewrite - all plugins must be updated
2. **Configuration**: Env vars still supported but YAML recommended
3. **Authentication**: Now required (can be disabled via config)
4. **API**: Some endpoints restructured around capabilities
5. **Frontend**: Widget system replaces hardcoded components
6. **CLI**: New CLI replaces any previous scripts
7. **Database**: Abstracted - SQLite still default but prepared for alternatives

## Migration Path

1. Backup existing Pabawi installation
2. Install v1.0.0
3. Run migration script to convert config
4. Create admin user
5. Test authentication
6. Verify plugins loaded
7. Test database migration
8. Update custom integrations (if any)

## Rollback Plan

Keep v0.x backup available. If issues arise:

1. Stop v1.0.0 server
2. Restore v0.x code and data
3. Restart v0.x server

## Database Strategy

### Current Implementation (v1.0.0)

- **SQLite**: Default and primary database
- **Adapter Pattern**: All database code abstracted behind `DatabaseAdapter` interface
- **Migration Support**: Version-tracked migrations work across adapters

### Future Database Support (v1.1+)

The abstraction layer enables adding:

1. **PostgreSQL**: For production deployments with high concurrency
   - Connection pooling
   - Better concurrent write performance
   - Advanced features (JSONB, full-text search)

2. **MySQL/MariaDB**: For organizations standardized on MySQL
   - Wide deployment support
   - Cloud provider compatibility

3. **Migration Path**:
   - Export data from SQLite
   - Initialize new database with schema
   - Import data via adapter
   - Update configuration

### Database Adapter Implementation Checklist

When adding a new database adapter:

- [ ] Implement `DatabaseAdapter` interface
- [ ] Handle dialect-specific SQL syntax
- [ ] Implement connection pooling
- [ ] Support transactions properly
- [ ] Write migration compatibility layer
- [ ] Add comprehensive tests
- [ ] Document configuration options
- [ ] Update factory to support new type

## CLI Synopsis Examples

```bash
# Core commands
pab login
pab logout  
pab whoami
pab config set output.format json
pab plugins list
pab capabilities

# Plugin commands (auto-generated from bolt plugin)
pab bolt run "uptime" --targets all
pab bolt task package --targets web-* --params '{"action":"install","name":"nginx"}'
pab bolt inventory

# Plugin commands (auto-generated from puppetdb plugin)
pab puppetdb facts web-01
pab puppetdb query "nodes { certname ~ 'web' }"
pab puppetdb reports --status failed --since 1h

# Plugin commands (auto-generated from hiera plugin)
pab hiera lookup ntp_servers --node web-01 --environment production
pab hiera keys --pattern '*password*'

# Debug mode
pab --debug bolt run "systemctl status nginx" --targets web-01

# Different output formats
pab bolt inventory --format table
pab bolt inventory --format json | jq '.[] | .certname'

# RBAC enforcement (user with viewer role)
$ pab bolt run "reboot" --targets all
âœ— Permission denied: You lack the 'command.execute' capability.
```

## Success Metrics

- All existing integrations (Bolt, PuppetDB, Puppetserver, Hiera) migrated
- Example external plugin working
- RBAC functioning across Web UI, API, CLI
- Debug mode tracking working
- CLI commands auto-generated from plugins
- Database abstraction layer complete with SQLite adapter
- Documentation complete
- All tests passing
- Migration from v0.x successful

## Timeline

- **Weeks 1-2:** Core plugin infrastructure + database abstraction
- **Week 3:** Authentication & authorization
- **Week 4:** Configuration system
- **Weeks 5-6:** Frontend plugin system
- **Week 7:** CLI application
- **Week 8:** Plugin migration & testing
- **Week 9:** Documentation & polish
- **Total:** 9 weeks to v1.0.0 release

## Future Considerations (v1.1+)

1. **Plugin Marketplace**: Registry for third-party plugins
2. **Hot Reload**: Reload plugins without server restart (production-safe)
3. **Multi-Tenancy**: Organization/tenant support
4. **SSO/LDAP**: Enterprise authentication
5. **Service Accounts**: API tokens for automation
6. **Widget Configuration UI**: Drag-and-drop dashboard builder
7. **Plugin Sandboxing**: Security isolation for untrusted plugins
8. **CLI Server Profiles**: Manage multiple Pabawi servers
9. **Streaming Output**: Real-time command output in CLI
10. **Plugin Dependencies**: Automatic dependency installation
11. **PostgreSQL Adapter**: Production-ready database backend
12. **MySQL Adapter**: Alternative database option
13. **Database Migration Tools**: GUI for database upgrades
14. **Multi-Database Support**: Read replicas, sharding

## Notes

### Database Abstraction Rationale

The database abstraction layer provides:

- **Flexibility**: Easy to switch databases based on deployment needs
- **Testing**: Mock adapters for unit tests without actual database
- **Performance**: Can optimize per-database (e.g., PostgreSQL JSONB for plugin configs)
- **Scalability**: Future support for read replicas, connection pooling strategies
- **Migration**: Smooth path from SQLite (development) to PostgreSQL (production)

SQLite remains the default for its simplicity and zero-configuration setup, making Pabawi easy to deploy for small teams and development. The abstraction ensures larger deployments can migrate to PostgreSQL without code changes.

---

**End of Plan Document**
