
services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
    image: pabawi:latest
    container_name: pabawi-dev
    volumes:
      # Mount entire workspace for development
      - .:/workspace:cached
      # Mount Bolt project directory (read-only)
      - ./test-bolt-project:/bolt-project:ro
      # Mount data directory for SQLite database (read-write)
      - ./data:/data
      # Persist node_modules
      - node_modules:/workspace/node_modules
      - backend_node_modules:/workspace/backend/node_modules
      - frontend_node_modules:/workspace/frontend/node_modules
    ports:
      - "${PORT:-3000}:3000"
    command: sleep infinity
    user: "1001:1001"
    environment:
      # Application configuration
      - NODE_ENV=development
      - PORT=3000
      
      # Bolt configuration
      - BOLT_PROJECT_PATH=/bolt-project
      
      # Database configuration
      - DATABASE_PATH=/data/executions.db
      
      # Command whitelist configuration
      - COMMAND_WHITELIST_ALLOW_ALL=${COMMAND_WHITELIST_ALLOW_ALL:-false}
      - COMMAND_WHITELIST=${COMMAND_WHITELIST:-["ls","pwd","whoami","uptime"]}
      
      # Execution configuration
      - EXECUTION_TIMEOUT=${EXECUTION_TIMEOUT:-300000}
      
      # Logging configuration
      - LOG_LEVEL=${LOG_LEVEL:-info}
    
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3
    
    restart: unless-stopped
    
    networks:
      - pabawi-network

networks:
  pabawi-network:
    driver: bridge

volumes:
  # Named volumes for node_modules persistence
  node_modules:
  backend_node_modules:
  frontend_node_modules:
  # Named volume for persistent data (alternative to bind mount)
  pabawi-data:
    driver: local
